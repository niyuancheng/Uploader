!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Uploader=t()}(this,(function(){"use strict";function e(e){throw new Error(e)}class t{constructor(e){this.dispatchEvent=function(e,...t){return this._events[e]&&this._events[e].forEach((e=>{e.call(this,...t)})),this},this._events={};for(let t in e)this[t]=e[t]}addEventListener(e,t){return this._events[e]=this._events[e]||[],!this._events[e].includes(t)&&this._events[e].push(t),this}removeEventListener(t,s){if(this._events[t].includes(s)){let e=this._events[t].indexOf(s);this._events[t].splice(e,1)}else e("传入的监听者不存在");return this}}function s(e,t,s,i){return new(s||(s=Promise))((function(n,r){function h(e){try{o(i.next(e))}catch(e){r(e)}}function a(e){try{o(i.throw(e))}catch(e){r(e)}}function o(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(h,a)}o((i=i.apply(e,t||[])).next())}))}class i{constructor(){this._events={}}sendRequest(e,t,s,i={},n,r,h,a){let o=new XMLHttpRequest;return{p:new Promise(((l,c)=>{o.upload.onloadstart=e=>{a.call(h,"chunkSend",r),this._events.chunkSend&&this._events.chunkSend.forEach((e=>e.call(this,a)))},o.upload.onprogress=e=>{r.percent=parseFloat((e.loaded/e.total).toFixed(2)),e.lengthComputable&&(a.call(h,"chunkProgress",n,r),this._events.fileProgress&&this._events.fileProgress.forEach((e=>e.call(this,a))))},o.onload=e=>{(o.status>=200&&o.status<300||304===o.status)&&l({data:JSON.parse(o.responseText),type:"success"})},o.onerror=e=>{c({data:o.responseText,type:"error"})},o.onabort=e=>{c({data:o.responseText,type:"abort"})},o.open(t,e);for(let e in i)o.setRequestHeader(e,i[e]);o.send(s)})),xhr:o}}}class n{constructor(){this._dataLength=0,this._bufferLength=0,this._state=new Int32Array(4),this._buffer=new ArrayBuffer(68),this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()}static hashStr(e,t=!1){return this.onePassHasher.start().appendStr(e).end(t)}static hashAsciiStr(e,t=!1){return this.onePassHasher.start().appendAsciiStr(e).end(t)}static _hex(e){const t=n.hexChars,s=n.hexOut;let i,r,h,a;for(a=0;a<4;a+=1)for(r=8*a,i=e[a],h=0;h<8;h+=2)s[r+1+h]=t.charAt(15&i),i>>>=4,s[r+0+h]=t.charAt(15&i),i>>>=4;return s.join("")}static _md5cycle(e,t){let s=e[0],i=e[1],n=e[2],r=e[3];s+=(i&n|~i&r)+t[0]-680876936|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+t[1]-389564586|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+t[2]+606105819|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+t[3]-1044525330|0,i=(i<<22|i>>>10)+n|0,s+=(i&n|~i&r)+t[4]-176418897|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+t[5]+1200080426|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+t[6]-1473231341|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+t[7]-45705983|0,i=(i<<22|i>>>10)+n|0,s+=(i&n|~i&r)+t[8]+1770035416|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+t[9]-1958414417|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+t[10]-42063|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+t[11]-1990404162|0,i=(i<<22|i>>>10)+n|0,s+=(i&n|~i&r)+t[12]+1804603682|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+t[13]-40341101|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+t[14]-1502002290|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+t[15]+1236535329|0,i=(i<<22|i>>>10)+n|0,s+=(i&r|n&~r)+t[1]-165796510|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+t[6]-1069501632|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+t[11]+643717713|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+t[0]-373897302|0,i=(i<<20|i>>>12)+n|0,s+=(i&r|n&~r)+t[5]-701558691|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+t[10]+38016083|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+t[15]-660478335|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+t[4]-405537848|0,i=(i<<20|i>>>12)+n|0,s+=(i&r|n&~r)+t[9]+568446438|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+t[14]-1019803690|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+t[3]-187363961|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+t[8]+1163531501|0,i=(i<<20|i>>>12)+n|0,s+=(i&r|n&~r)+t[13]-1444681467|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+t[2]-51403784|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+t[7]+1735328473|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+t[12]-1926607734|0,i=(i<<20|i>>>12)+n|0,s+=(i^n^r)+t[5]-378558|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+t[8]-2022574463|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+t[11]+1839030562|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+t[14]-35309556|0,i=(i<<23|i>>>9)+n|0,s+=(i^n^r)+t[1]-1530992060|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+t[4]+1272893353|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+t[7]-155497632|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+t[10]-1094730640|0,i=(i<<23|i>>>9)+n|0,s+=(i^n^r)+t[13]+681279174|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+t[0]-358537222|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+t[3]-722521979|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+t[6]+76029189|0,i=(i<<23|i>>>9)+n|0,s+=(i^n^r)+t[9]-640364487|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+t[12]-421815835|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+t[15]+530742520|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+t[2]-995338651|0,i=(i<<23|i>>>9)+n|0,s+=(n^(i|~r))+t[0]-198630844|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+t[7]+1126891415|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+t[14]-1416354905|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+t[5]-57434055|0,i=(i<<21|i>>>11)+n|0,s+=(n^(i|~r))+t[12]+1700485571|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+t[3]-1894986606|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+t[10]-1051523|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+t[1]-2054922799|0,i=(i<<21|i>>>11)+n|0,s+=(n^(i|~r))+t[8]+1873313359|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+t[15]-30611744|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+t[6]-1560198380|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+t[13]+1309151649|0,i=(i<<21|i>>>11)+n|0,s+=(n^(i|~r))+t[4]-145523070|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+t[11]-1120210379|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+t[2]+718787259|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+t[9]-343485551|0,i=(i<<21|i>>>11)+n|0,e[0]=s+e[0]|0,e[1]=i+e[1]|0,e[2]=n+e[2]|0,e[3]=r+e[3]|0}start(){return this._dataLength=0,this._bufferLength=0,this._state.set(n.stateIdentity),this}appendStr(e){const t=this._buffer8,s=this._buffer32;let i,r,h=this._bufferLength;for(r=0;r<e.length;r+=1){if(i=e.charCodeAt(r),i<128)t[h++]=i;else if(i<2048)t[h++]=192+(i>>>6),t[h++]=63&i|128;else if(i<55296||i>56319)t[h++]=224+(i>>>12),t[h++]=i>>>6&63|128,t[h++]=63&i|128;else{if(i=1024*(i-55296)+(e.charCodeAt(++r)-56320)+65536,i>1114111)throw new Error("Unicode standard supports code points up to U+10FFFF");t[h++]=240+(i>>>18),t[h++]=i>>>12&63|128,t[h++]=i>>>6&63|128,t[h++]=63&i|128}h>=64&&(this._dataLength+=64,n._md5cycle(this._state,s),h-=64,s[0]=s[16])}return this._bufferLength=h,this}appendAsciiStr(e){const t=this._buffer8,s=this._buffer32;let i,r=this._bufferLength,h=0;for(;;){for(i=Math.min(e.length-h,64-r);i--;)t[r++]=e.charCodeAt(h++);if(r<64)break;this._dataLength+=64,n._md5cycle(this._state,s),r=0}return this._bufferLength=r,this}appendByteArray(e){const t=this._buffer8,s=this._buffer32;let i,r=this._bufferLength,h=0;for(;;){for(i=Math.min(e.length-h,64-r);i--;)t[r++]=e[h++];if(r<64)break;this._dataLength+=64,n._md5cycle(this._state,s),r=0}return this._bufferLength=r,this}getState(){const e=this._state;return{buffer:String.fromCharCode.apply(null,Array.from(this._buffer8)),buflen:this._bufferLength,length:this._dataLength,state:[e[0],e[1],e[2],e[3]]}}setState(e){const t=e.buffer,s=e.state,i=this._state;let n;for(this._dataLength=e.length,this._bufferLength=e.buflen,i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],n=0;n<t.length;n+=1)this._buffer8[n]=t.charCodeAt(n)}end(e=!1){const t=this._bufferLength,s=this._buffer8,i=this._buffer32,r=1+(t>>2);this._dataLength+=t;const h=8*this._dataLength;if(s[t]=128,s[t+1]=s[t+2]=s[t+3]=0,i.set(n.buffer32Identity.subarray(r),r),t>55&&(n._md5cycle(this._state,i),i.set(n.buffer32Identity)),h<=4294967295)i[14]=h;else{const e=h.toString(16).match(/(.*?)(.{0,8})$/);if(null===e)return;const t=parseInt(e[2],16),s=parseInt(e[1],16)||0;i[14]=t,i[15]=s}return n._md5cycle(this._state,i),e?this._state:n._hex(this._state)}}if(n.stateIdentity=new Int32Array([1732584193,-271733879,-1732584194,271733878]),n.buffer32Identity=new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),n.hexChars="0123456789abcdef",n.hexOut=[],n.onePassHasher=new n,"5d41402abc4b2a76b9719d911017c592"!==n.hashStr("hello"))throw new Error("Md5 self test failed.");class r{constructor(e,t){this._queue=[],this._ready=!0;const s=this;Worker?(s._hashWorker=new Worker(e,t),s._hashWorker.onmessage=s._recievedMessage.bind(s),s._hashWorker.onerror=e=>{s._ready=!1,console.error("Hash worker failure",e)}):(s._ready=!1,console.error("Web Workers are not supported in this browser"))}hash(e){const t=this;let s;return s=new Promise(((s,i)=>{t._queue.push({blob:e,resolve:s,reject:i}),t._processNext()})),s}terminate(){this._ready=!1,this._hashWorker.terminate()}_processNext(){this._ready&&!this._processing&&this._queue.length>0&&(this._processing=this._queue.pop(),this._hashWorker.postMessage(this._processing.blob))}_recievedMessage(e){var t,s;const i=e.data;i.success?null===(t=this._processing)||void 0===t||t.resolve(i.result):null===(s=this._processing)||void 0===s||s.reject(i.result),this._processing=void 0,this._processNext()}}class h extends i{constructor(e,t,s,i){super(),this.tasks=[],this.chunks=[],this.isFileSend=!1,this.workerPath="",this.file=e,this.context=t,this.dispatchEvent=s,this.workerPath=i,this.chunks.push({chunk:this.file,id:"",percent:0,size:this.file.size}),this.initEvent()}initEvent(){this._events.fileProgress=this._events.fileProgress||[],this._events.fileProgress.push((e=>{let t=0;this.chunks.forEach((e=>{t+=e.percent*e.size})),e.call(this.context,"fileProgress",this.fileItem,t,this.file.size)})),this._events.chunkSend=this._events.chunkSend||[],this._events.chunkSend.push((e=>{this.isFileSend||(this.isFileSend=!0,e.call(this.context,"fileSend",this.file))}))}slice(e){let t=this.file.size,s=0,i=new Array;for(;s<t;){let t=s+e,n=this.file.slice(s,t);i.push({chunk:n,id:"",percent:0,size:n.size}),s=t}this.chunks=i}getHashId(e){return new Promise(((t,s)=>{new r(this.workerPath).hash(e).then((e=>{t(e)}),(e=>{s(e)}))}))}generateId(){return Promise.all([this.getHashId(this.file),...this.chunks.map((e=>this.getHashId(e.chunk)))])}getUploadedChunk(e){let t=window.sessionStorage.getItem("$file"+e);return t?JSON.parse(t):[]}saveUploadedChunk(e,t){let s=window.sessionStorage.getItem("$file"+e)?JSON.parse(window.sessionStorage.getItem("$file"+e)):[];s.push(t),window.sessionStorage.setItem("$file"+e,JSON.stringify(s))}addTask(e,t,s){this.chunks.forEach(((t,i)=>{if(!this.getUploadedChunk(this.fileId).includes(t.id)){let i=new FormData;i.append("fileId",this.fileId),i.append("chunk",t.chunk),i.append("chunkId",t.id);let{p:n,xhr:r}=this.sendRequest(e,"post",i,{"Content-Type":"multipart/form-data;charset=utf-8"},this.fileItem,t,this.context,s);n.then((e=>{this.saveUploadedChunk(this.fileId,t.id),"success"===e.type&&(s.call(this.context,"chunkSuccess",this.fileItem,t,e.data),s.call(this.context,"chunkComplete",this.fileItem,t,e.data))}),(e=>{"abort"===e.type?(s.call(this.context,"chunkAbort",this.fileItem,t,e.data),s.call(this.context,"chunkComplete",this.fileItem,t,e.data)):"error"===e.type&&(s.call(this.context,"chunkError",this.fileItem,t,e.data),s.call(this.context,"chunkComplete",this.fileItem,t,e.data))})),this.tasks.push({p:n,xhr:r,chunkItem:t})}}))}triggerTask(e){Promise.allSettled(this.tasks).then((t=>{for(let s of t)if("rejected"===s.status)return e.call(this.context,"fileComplete",this.fileItem);e.call(this.context,"fileComplete",this.fileItem),e.call(this.context,"fileSuccess",this.fileItem)}))}uploadTask(e,t,i,n,r){return s(this,void 0,void 0,(function*(){if(r&&!sessionStorage.getItem(`file${this.fileId}`)){this.slice(e);let[t,...s]=yield this.generateId();this.fileId=t;for(let e in s)this.chunks[e].id=s[e];this.fileItem={file:this.file,id:this.fileId,size:this.file.size}}this.addTask(t,i,n),this.triggerTask(n)}))}cancelTask(){this.tasks.forEach(((e,t)=>{this.getUploadedChunk(this.fileId).includes(e.chunkItem.id)||e.xhr.abort()}))}}console.log("%c UploaderJS: %c 欢迎使用大文件传输库UploadeJS，UploaderJS是一款效率极高的文件上传库，具有多种完善配置，关注作者Nova获取更多最新咨询吧","background: #606060; color: #fff; border-radius: 3px 0 0 3px;","background: #1475B2; color: #fff; border-radius: 0 3px 3px 0;");const a=/\s*#.+/g,o=/\s*\..+/g;return class extends t{constructor(e,t={}){super(t),this.configuration={ifSendByChunk:!0,chunkSize:104857.6,autoUpload:!0,workerPath:"/hash_worker.js",chunkApi:"",fileApi:""},this.fileMap=new Map,this.lastUploadTime=0,this.gapTime=0,this.dispatchEvent=function(e,...t){this._events[e]&&this._events[e].forEach((e=>e.call(this,...t)))},this.configuration=Object.assign(this.configuration,e),this.init()}init(){let e=this.configuration.target||void 0;e&&this.assign(e),this.clearChunkStorage(),this.showProgress()}clearChunkStorage(){for(let e in window.sessionStorage)/^\$file.*/.test(e)&&window.sessionStorage.removeItem(e)}assign(t){if("string"==typeof t)if(a.test(t)){let s=document.querySelector(t);s||e("无法找到传入的id对应的DOM元素"),s instanceof HTMLInputElement&&"file"===s.type?this.fileInputElement=s:e("传入的id对应的DOM元素不是file类型")}else if(o.test(t)){let s=document.querySelectorAll(t)[0];s||e("无法找到传入的class对应的DOM元素"),s instanceof HTMLInputElement&&"file"===s.type?this.fileInputElement=s:e("传入的class对应的DOM元素不是file类型")}else e("传入的target参数类型错误");else t instanceof HTMLInputElement?"file"===t.type?this.fileInputElement=t:e("传入的DOM元素不是file类型"):e("传入的target只能为字符串或者DOM元素");this.fileInputElement.addEventListener("change",(e=>{[...e.target.files].forEach((e=>{console.log(e);let t=new h(e,this,this.dispatchEvent,this.configuration.workerPath);this.fileMap.set(e,t),this.configuration.autoUpload&&this.uploadFile(e,this.configuration.ifSendByChunk)}))}))}uploadFile(t,s=!0){if(!this.fileMap.get(t))return e("你输入的文件不存在");this.fileMap.get(t).uploadTask(this.configuration.chunkSize,this.configuration.chunkApi,this.configuration.fileApi,this.dispatchEvent,s)}cancelUploadFile(t){if(!this.fileMap.get(t))return e("你输入的文件不存在");this.fileMap.get(t).cancelTask()}formatSize(e){return e<1024?`${e.toFixed(2)}B`:e>=1024&&e<1048576?`${(e/1024).toFixed(2)}KB`:`${(e/1024*1024).toFixed(2)}MB`}showProgress(){this.addEventListener("fileSend",((e,t)=>{this.lastUploadTime=+new Date})),this.addEventListener("fileProgress",((e,t,s)=>{let i=+new Date,n=i-this.lastUploadTime;this.gapTime=0===n?this.gapTime:n;let r=t/this.gapTime,h=(t/s*100).toFixed(1),a=(s-t)/r;this.lastUploadTime=i,this.dispatchEvent("filePercent",r,h,a)}))}}}));
