function t(t){throw new Error(t)}class e{constructor(t){this.dispatchEvent=function(t,...e){return this._events[t]&&this._events[t].forEach((t=>{t.call(this,...e)})),this},this._events={};for(let e in t)this[e]=t[e]}addEventListener(t,e){return this._events[t]=this._events[t]||[],!this._events[t].includes(e)&&this._events[t].push(e),this}removeEventListener(e,s){if(this._events[e].includes(s)){let t=this._events[e].indexOf(s);this._events[e].splice(t,1)}else t("传入的监听者不存在");return this}}function s(t,e,s,i){return new(s||(s=Promise))((function(n,r){function h(t){try{o(i.next(t))}catch(t){r(t)}}function a(t){try{o(i.throw(t))}catch(t){r(t)}}function o(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(h,a)}o((i=i.apply(t,e||[])).next())}))}class i{constructor(){this.loadedSizeArray=[],this._events={}}sendRequest(t,e,s,i={},n,r,h){let a=new XMLHttpRequest;return{p:new Promise(((o,l)=>{a.upload.onloadstart=t=>{h.call(r,"chunkSend",n),this._events.chunkSend&&this._events.chunkSend.forEach((t=>t.call(this,h)))},a.upload.onprogress=t=>{t.lengthComputable&&(h.call(r,"chunkProgress",n,t.loaded,t.total),n.percent=parseFloat((t.loaded/t.total).toFixed(2)),this._events.fileProgress&&this._events.fileProgress.forEach((t=>t.call(this,h))))},a.onload=t=>{(a.status>=200&&a.status<300||304===a.status)&&o({data:JSON.parse(a.responseText),type:"success"})},a.onerror=t=>{l({data:a.responseText,type:"error"})},a.onabort=t=>{l({data:a.responseText,type:"abort"})},a.open(e,t);for(let t in i)a.setRequestHeader(t,i[t]);a.send(s)})),xhr:a}}}class n{constructor(){this._dataLength=0,this._bufferLength=0,this._state=new Int32Array(4),this._buffer=new ArrayBuffer(68),this._buffer8=new Uint8Array(this._buffer,0,68),this._buffer32=new Uint32Array(this._buffer,0,17),this.start()}static hashStr(t,e=!1){return this.onePassHasher.start().appendStr(t).end(e)}static hashAsciiStr(t,e=!1){return this.onePassHasher.start().appendAsciiStr(t).end(e)}static _hex(t){const e=n.hexChars,s=n.hexOut;let i,r,h,a;for(a=0;a<4;a+=1)for(r=8*a,i=t[a],h=0;h<8;h+=2)s[r+1+h]=e.charAt(15&i),i>>>=4,s[r+0+h]=e.charAt(15&i),i>>>=4;return s.join("")}static _md5cycle(t,e){let s=t[0],i=t[1],n=t[2],r=t[3];s+=(i&n|~i&r)+e[0]-680876936|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+e[1]-389564586|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+e[2]+606105819|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+e[3]-1044525330|0,i=(i<<22|i>>>10)+n|0,s+=(i&n|~i&r)+e[4]-176418897|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+e[5]+1200080426|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+e[6]-1473231341|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+e[7]-45705983|0,i=(i<<22|i>>>10)+n|0,s+=(i&n|~i&r)+e[8]+1770035416|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+e[9]-1958414417|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+e[10]-42063|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+e[11]-1990404162|0,i=(i<<22|i>>>10)+n|0,s+=(i&n|~i&r)+e[12]+1804603682|0,s=(s<<7|s>>>25)+i|0,r+=(s&i|~s&n)+e[13]-40341101|0,r=(r<<12|r>>>20)+s|0,n+=(r&s|~r&i)+e[14]-1502002290|0,n=(n<<17|n>>>15)+r|0,i+=(n&r|~n&s)+e[15]+1236535329|0,i=(i<<22|i>>>10)+n|0,s+=(i&r|n&~r)+e[1]-165796510|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+e[6]-1069501632|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+e[11]+643717713|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+e[0]-373897302|0,i=(i<<20|i>>>12)+n|0,s+=(i&r|n&~r)+e[5]-701558691|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+e[10]+38016083|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+e[15]-660478335|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+e[4]-405537848|0,i=(i<<20|i>>>12)+n|0,s+=(i&r|n&~r)+e[9]+568446438|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+e[14]-1019803690|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+e[3]-187363961|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+e[8]+1163531501|0,i=(i<<20|i>>>12)+n|0,s+=(i&r|n&~r)+e[13]-1444681467|0,s=(s<<5|s>>>27)+i|0,r+=(s&n|i&~n)+e[2]-51403784|0,r=(r<<9|r>>>23)+s|0,n+=(r&i|s&~i)+e[7]+1735328473|0,n=(n<<14|n>>>18)+r|0,i+=(n&s|r&~s)+e[12]-1926607734|0,i=(i<<20|i>>>12)+n|0,s+=(i^n^r)+e[5]-378558|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+e[8]-2022574463|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+e[11]+1839030562|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+e[14]-35309556|0,i=(i<<23|i>>>9)+n|0,s+=(i^n^r)+e[1]-1530992060|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+e[4]+1272893353|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+e[7]-155497632|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+e[10]-1094730640|0,i=(i<<23|i>>>9)+n|0,s+=(i^n^r)+e[13]+681279174|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+e[0]-358537222|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+e[3]-722521979|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+e[6]+76029189|0,i=(i<<23|i>>>9)+n|0,s+=(i^n^r)+e[9]-640364487|0,s=(s<<4|s>>>28)+i|0,r+=(s^i^n)+e[12]-421815835|0,r=(r<<11|r>>>21)+s|0,n+=(r^s^i)+e[15]+530742520|0,n=(n<<16|n>>>16)+r|0,i+=(n^r^s)+e[2]-995338651|0,i=(i<<23|i>>>9)+n|0,s+=(n^(i|~r))+e[0]-198630844|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+e[7]+1126891415|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+e[14]-1416354905|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+e[5]-57434055|0,i=(i<<21|i>>>11)+n|0,s+=(n^(i|~r))+e[12]+1700485571|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+e[3]-1894986606|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+e[10]-1051523|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+e[1]-2054922799|0,i=(i<<21|i>>>11)+n|0,s+=(n^(i|~r))+e[8]+1873313359|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+e[15]-30611744|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+e[6]-1560198380|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+e[13]+1309151649|0,i=(i<<21|i>>>11)+n|0,s+=(n^(i|~r))+e[4]-145523070|0,s=(s<<6|s>>>26)+i|0,r+=(i^(s|~n))+e[11]-1120210379|0,r=(r<<10|r>>>22)+s|0,n+=(s^(r|~i))+e[2]+718787259|0,n=(n<<15|n>>>17)+r|0,i+=(r^(n|~s))+e[9]-343485551|0,i=(i<<21|i>>>11)+n|0,t[0]=s+t[0]|0,t[1]=i+t[1]|0,t[2]=n+t[2]|0,t[3]=r+t[3]|0}start(){return this._dataLength=0,this._bufferLength=0,this._state.set(n.stateIdentity),this}appendStr(t){const e=this._buffer8,s=this._buffer32;let i,r,h=this._bufferLength;for(r=0;r<t.length;r+=1){if(i=t.charCodeAt(r),i<128)e[h++]=i;else if(i<2048)e[h++]=192+(i>>>6),e[h++]=63&i|128;else if(i<55296||i>56319)e[h++]=224+(i>>>12),e[h++]=i>>>6&63|128,e[h++]=63&i|128;else{if(i=1024*(i-55296)+(t.charCodeAt(++r)-56320)+65536,i>1114111)throw new Error("Unicode standard supports code points up to U+10FFFF");e[h++]=240+(i>>>18),e[h++]=i>>>12&63|128,e[h++]=i>>>6&63|128,e[h++]=63&i|128}h>=64&&(this._dataLength+=64,n._md5cycle(this._state,s),h-=64,s[0]=s[16])}return this._bufferLength=h,this}appendAsciiStr(t){const e=this._buffer8,s=this._buffer32;let i,r=this._bufferLength,h=0;for(;;){for(i=Math.min(t.length-h,64-r);i--;)e[r++]=t.charCodeAt(h++);if(r<64)break;this._dataLength+=64,n._md5cycle(this._state,s),r=0}return this._bufferLength=r,this}appendByteArray(t){const e=this._buffer8,s=this._buffer32;let i,r=this._bufferLength,h=0;for(;;){for(i=Math.min(t.length-h,64-r);i--;)e[r++]=t[h++];if(r<64)break;this._dataLength+=64,n._md5cycle(this._state,s),r=0}return this._bufferLength=r,this}getState(){const t=this._state;return{buffer:String.fromCharCode.apply(null,Array.from(this._buffer8)),buflen:this._bufferLength,length:this._dataLength,state:[t[0],t[1],t[2],t[3]]}}setState(t){const e=t.buffer,s=t.state,i=this._state;let n;for(this._dataLength=t.length,this._bufferLength=t.buflen,i[0]=s[0],i[1]=s[1],i[2]=s[2],i[3]=s[3],n=0;n<e.length;n+=1)this._buffer8[n]=e.charCodeAt(n)}end(t=!1){const e=this._bufferLength,s=this._buffer8,i=this._buffer32,r=1+(e>>2);this._dataLength+=e;const h=8*this._dataLength;if(s[e]=128,s[e+1]=s[e+2]=s[e+3]=0,i.set(n.buffer32Identity.subarray(r),r),e>55&&(n._md5cycle(this._state,i),i.set(n.buffer32Identity)),h<=4294967295)i[14]=h;else{const t=h.toString(16).match(/(.*?)(.{0,8})$/);if(null===t)return;const e=parseInt(t[2],16),s=parseInt(t[1],16)||0;i[14]=e,i[15]=s}return n._md5cycle(this._state,i),t?this._state:n._hex(this._state)}}if(n.stateIdentity=new Int32Array([1732584193,-271733879,-1732584194,271733878]),n.buffer32Identity=new Int32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),n.hexChars="0123456789abcdef",n.hexOut=[],n.onePassHasher=new n,"5d41402abc4b2a76b9719d911017c592"!==n.hashStr("hello"))throw new Error("Md5 self test failed.");class r{constructor(t,e){this._queue=[],this._ready=!0;const s=this;Worker?(s._hashWorker=new Worker(t,e),s._hashWorker.onmessage=s._recievedMessage.bind(s),s._hashWorker.onerror=t=>{s._ready=!1,console.error("Hash worker failure",t)}):(s._ready=!1,console.error("Web Workers are not supported in this browser"))}hash(t){const e=this;let s;return s=new Promise(((s,i)=>{e._queue.push({blob:t,resolve:s,reject:i}),e._processNext()})),s}terminate(){this._ready=!1,this._hashWorker.terminate()}_processNext(){this._ready&&!this._processing&&this._queue.length>0&&(this._processing=this._queue.pop(),this._hashWorker.postMessage(this._processing.blob))}_recievedMessage(t){var e,s;const i=t.data;i.success?null===(e=this._processing)||void 0===e||e.resolve(i.result):null===(s=this._processing)||void 0===s||s.reject(i.result),this._processing=void 0,this._processNext()}}class h extends i{constructor(t,e,s,i){super(),this.tasks=[],this.chunks=[],this.isFileSend=!1,this.workerPath="",this.file=t,this.context=e,this.dispatchEvent=s,this.workerPath=i,this.chunks.push({chunk:this.file,id:"",percent:0,size:this.file.size}),this.initEvent()}initEvent(){this._events.fileProgress=this._events.fileProgress||[],this._events.fileProgress.push((t=>{let e=0;this.chunks.forEach((t=>{e+=t.percent*t.size})),t.call(this.context,"fileProgress",this.file,e,this.file.size)})),this._events.chunkSend=this._events.chunkSend||[],this._events.chunkSend.push((t=>{this.isFileSend||(this.isFileSend=!0,t.call(this.context,"fileSend",this.file))}))}slice(t){let e=this.file.size,s=0,i=new Array;for(;s<e;){let e=s+t,n=this.file.slice(s,e);i.push({chunk:n,id:"",percent:0,size:n.size}),s=e}this.chunks=i}getHashId(t){return new Promise(((e,s)=>{new r(this.workerPath).hash(t).then((t=>{e(t)}),(t=>{s(t)}))}))}generateId(){return Promise.all([this.getHashId(this.file),...this.chunks.map((t=>this.getHashId(t.chunk)))])}getUploadedChunk(t){let e=window.sessionStorage.getItem("$file"+t);return e?JSON.parse(e):[]}saveUploadedChunk(t,e){let s=window.sessionStorage.getItem("$file"+t)?JSON.parse(window.sessionStorage.getItem("$file"+t)):[];s.push(e),window.sessionStorage.setItem("$file"+t,JSON.stringify(s))}addTask(t,e,s){this.chunks.forEach(((e,i)=>{if(!this.getUploadedChunk(this.fileId).includes(e.id)){let i=new FormData;i.append("fileId",this.fileId),i.append("chunk",e.chunk),i.append("chunkId",e.id);let{p:n,xhr:r}=this.sendRequest(t,"post",i,{"Content-Type":"multipart/form-data;charset=utf-8"},e,this.context,s);n.then((t=>{this.saveUploadedChunk(this.fileId,e.id),"success"===t.type&&(s.call(this.context,"chunkSuccess",this.file,e,t.data),s.call(this.context,"chunkComplete",this.file,e,t.data))}),(t=>{"abort"===t.type?(s.call(this.context,"chunkAbort",this.file,e,t.data),s.call(this.context,"chunkComplete",this.file,e,t.data)):"error"===t.type&&(s.call(this.context,"chunkError",this.file,e,t.data),s.call(this.context,"chunkComplete",this.file,e,t.data))})),this.tasks.push({p:n,xhr:r,chunkItem:e})}}))}triggerTask(t){Promise.allSettled(this.tasks).then((e=>{for(let s of e)if("rejected"===s.status)return t.call(this.context,"fileComplete",this.file);t.call(this.context,"fileComplete",this.file),t.call(this.context,"fileSuccess",this.file)}))}uploadTask(t,e,i,n,r){return s(this,void 0,void 0,(function*(){if(r&&!sessionStorage.getItem(`file${this.fileId}`)){this.slice(t);let[e,...s]=yield this.generateId();console.log(e,s,this,s),this.fileId=e;for(let t in s)this.chunks[t].id=s[t]}this.addTask(e,i,n),this.triggerTask(n)}))}cancelTask(){this.tasks.forEach(((t,e)=>{this.getUploadedChunk(this.fileId).includes(t.chunkItem.id)||t.xhr.abort()}))}}console.log("%c UploaderJS: %c 欢迎使用大文件传输库UploadeJS，UploaderJS是一款效率极高的文件上传库，具有多种完善配置，关注作者Nova获取更多最新咨询吧","background: #606060; color: #fff; border-radius: 3px 0 0 3px;","background: #1475B2; color: #fff; border-radius: 0 3px 3px 0;");const a=/\s*#.+/g,o=/\s*\..+/g;class l extends e{constructor(t,e={}){super(e),this.configuration={ifSendByChunk:!0,chunkSize:104857.6,autoUpload:!0,workerPath:"../hash_worker.js",chunkApi:"",fileApi:""},this.fileMap=new Map,this.lastUploadTime=0,this.dispatchEvent=function(t,...e){this._events[t]&&this._events[t].forEach((t=>t.call(this,...e)))},this.configuration=Object.assign(this.configuration,t),this.init()}init(){let t=this.configuration.target||void 0;t&&this.assign(t),this.clearChunkStorage(),this.showProgress()}clearChunkStorage(){for(let t in window.sessionStorage)/^\$file.*/.test(t)&&window.sessionStorage.removeItem(t)}assign(e){if("string"==typeof e)if(a.test(e)){let s=document.querySelector(e);s||t("无法找到传入的id对应的DOM元素"),s instanceof HTMLInputElement&&"file"===s.type?this.fileInputElement=s:t("传入的id对应的DOM元素不是file类型")}else if(o.test(e)){let s=document.querySelectorAll(e)[0];s||t("无法找到传入的class对应的DOM元素"),s instanceof HTMLInputElement&&"file"===s.type?this.fileInputElement=s:t("传入的class对应的DOM元素不是file类型")}else t("传入的target参数类型错误");else e instanceof HTMLInputElement?"file"===e.type?this.fileInputElement=e:t("传入的DOM元素不是file类型"):t("传入的target只能为字符串或者DOM元素");this.fileInputElement.addEventListener("change",(t=>{[...t.target.files].forEach((t=>{console.log(t);let e=new h(t,this,this.dispatchEvent,this.configuration.workerPath);this.fileMap.set(t,e),this.configuration.autoUpload&&this.uploadFile(t,this.configuration.ifSendByChunk)}))}))}uploadFile(e,s=!0){if(!this.fileMap.get(e))return t("你输入的文件不存在");this.fileMap.get(e).uploadTask(this.configuration.chunkSize,this.configuration.chunkApi,this.configuration.fileApi,this.dispatchEvent,s)}cancelUploadFile(e){if(!this.fileMap.get(e))return t("你输入的文件不存在");this.fileMap.get(e).cancelTask()}formatSize(t){return t<1024?`${t.toFixed(2)}B`:t>=1024&&t<1048576?`${(t/1024).toFixed(2)}KB`:`${(t/1024*1024).toFixed(2)}MB`}showProgress(){this.addEventListener("fileSend",((t,e)=>{this.lastUploadTime=+new Date})),this.addEventListener("fileProgress",((t,e,s)=>{let i=+new Date,n=i-this.lastUploadTime;console.log(i,n);let r=e/n,h=(e/s*100).toFixed(1),a=(s-e)/r;this.lastUploadTime=i,this.dispatchEvent("filePercent",r,h,a)}))}}export{l as default};
